name: Build Windows Desktop

on:
  push:
    branches:
      - main
    tags:
      - "v*"
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      build_installer:
        description: "Build installer (slower)"
        required: false
        default: true
        type: boolean
      clean_build:
        description: "Force clean build (delete all generated files)"
        required: false
        default: true
        type: boolean

# Permissões necessárias para criar releases
permissions:
  contents: write

env:
  APP_NAME: POS Moloni
  APP_EXECUTABLE: pos_moloni_app.exe
  APP_VERSION: 1.0.0
  FLUTTER_VERSION: "3.24.5"

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: true

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Get Flutter version
        run: flutter --version

      # ============================================
      # LIMPEZA COMPLETA
      # ============================================
      - name: Clean previous builds
        run: |
          Write-Host "=== Cleaning previous builds ===" -ForegroundColor Yellow

          # Limpar build do Flutter
          flutter clean

          # Remover ficheiros gerados (.g.dart, .freezed.dart, etc.)
          Write-Host "Removing generated files..." -ForegroundColor Cyan
          Get-ChildItem -Path "lib" -Recurse -Include "*.g.dart","*.freezed.dart","*.gr.dart" -ErrorAction SilentlyContinue | Remove-Item -Force -ErrorAction SilentlyContinue

          # Remover .dart_tool/build (cache do build_runner)
          if (Test-Path ".dart_tool/build") {
            Remove-Item -Recurse -Force ".dart_tool/build"
            Write-Host "Removed .dart_tool/build" -ForegroundColor Green
          }

          # Limpar pub cache local
          if (Test-Path ".dart_tool/package_config.json") {
            Remove-Item -Force ".dart_tool/package_config.json"
          }

          Write-Host "=== Clean complete ===" -ForegroundColor Green
        shell: pwsh

      - name: Get dependencies
        run: flutter pub get

      # ============================================
      # GERAÇÃO DE CÓDIGO
      # ============================================
      - name: Clean build_runner cache
        run: dart run build_runner clean
        continue-on-error: true

      - name: Generate code (build_runner)
        run: |
          Write-Host "=== Generating code ===" -ForegroundColor Yellow
          dart run build_runner build --delete-conflicting-outputs --verbose
          Write-Host "=== Code generation complete ===" -ForegroundColor Green
        shell: pwsh

      - name: Verify generated files
        run: |
          Write-Host "=== Verifying generated files ===" -ForegroundColor Yellow

          # Listar ficheiros .g.dart gerados
          $generatedFiles = Get-ChildItem -Path "lib" -Recurse -Include "*.g.dart" -ErrorAction SilentlyContinue

          Write-Host "Generated files found: $($generatedFiles.Count)" -ForegroundColor Cyan
          $generatedFiles | ForEach-Object { Write-Host "  - $($_.FullName)" }

          if ($generatedFiles.Count -eq 0) {
            Write-Host "WARNING: No generated files found!" -ForegroundColor Red
          }
        shell: pwsh

      # ============================================
      # ANÁLISE
      # ============================================
      - name: Analyze code
        run: flutter analyze --no-fatal-infos

      # ============================================
      # BUILD
      # ============================================
      - name: Build Windows release
        run: |
          Write-Host "=== Building Windows release ===" -ForegroundColor Yellow
          flutter build windows --release --verbose
          Write-Host "=== Build complete ===" -ForegroundColor Green
        shell: pwsh

      - name: List build output
        run: |
          Write-Host "=== Build Output ===" -ForegroundColor Green
          Get-ChildItem -Recurse build/windows/x64/runner/Release | Select-Object FullName, Length
        shell: pwsh

      # ============================================
      # PORTABLE ZIP (sempre gerado)
      # ============================================
      - name: Create portable ZIP
        run: |
          $version = "${{ env.APP_VERSION }}"
          $zipName = "POS-Moloni-Windows-v$version-portable.zip"
          Compress-Archive -Path "build/windows/x64/runner/Release/*" -DestinationPath $zipName
          Write-Host "Created: $zipName" -ForegroundColor Green
        shell: pwsh

      - name: Upload portable ZIP
        uses: actions/upload-artifact@v4
        with:
          name: windows-portable
          path: POS-Moloni-Windows-*.zip
          if-no-files-found: error

      # ============================================
      # INSTALADOR INNO SETUP
      # ============================================
      - name: Create Inno Setup script
        if: ${{ github.event.inputs.build_installer != 'false' }}
        run: |
          @"
          ; Inno Setup Script for POS Moloni
          #define MyAppName "${{ env.APP_NAME }}"
          #define MyAppVersion "${{ env.APP_VERSION }}"
          #define MyAppPublisher "Loja da Madalena"
          #define MyAppURL "https://github.com/${{ github.repository }}"
          #define MyAppExeName "${{ env.APP_EXECUTABLE }}"

          [Setup]
          AppId={{A1B2C3D4-E5F6-7890-ABCD-EF1234567890}
          AppName={#MyAppName}
          AppVersion={#MyAppVersion}
          AppPublisher={#MyAppPublisher}
          AppPublisherURL={#MyAppURL}
          AppSupportURL={#MyAppURL}
          AppUpdatesURL={#MyAppURL}
          DefaultDirName={autopf}\{#MyAppName}
          DefaultGroupName={#MyAppName}
          AllowNoIcons=yes
          LicenseFile=
          OutputDir=installer_output
          OutputBaseFilename=POS-Moloni-Windows-v{#MyAppVersion}-setup
          SetupIconFile=
          Compression=lzma2/ultra64
          SolidCompression=yes
          WizardStyle=modern
          PrivilegesRequired=admin
          ArchitecturesAllowed=x64compatible
          ArchitecturesInstallIn64BitMode=x64compatible

          [Languages]
          Name: "portuguese"; MessagesFile: "compiler:Languages\Portuguese.isl"
          Name: "english"; MessagesFile: "compiler:Default.isl"

          [Tasks]
          Name: "desktopicon"; Description: "{cm:CreateDesktopIcon}"; GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked
          Name: "quicklaunchicon"; Description: "{cm:CreateQuickLaunchIcon}"; GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked; OnlyBelowVersion: 6.1; Check: not IsAdminInstallMode

          [Files]
          Source: "build\windows\x64\runner\Release\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs

          [Icons]
          Name: "{group}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"
          Name: "{group}\{cm:UninstallProgram,{#MyAppName}}"; Filename: "{uninstallexe}"
          Name: "{autodesktop}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"; Tasks: desktopicon
          Name: "{userappdata}\Microsoft\Internet Explorer\Quick Launch\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"; Tasks: quicklaunchicon

          [Run]
          Filename: "{app}\{#MyAppExeName}"; Description: "{cm:LaunchProgram,{#StringChange(MyAppName, '&', '&&')}}"; Flags: nowait postinstall skipifsilent

          [UninstallDelete]
          Type: filesandordirs; Name: "{app}"
          "@ | Out-File -FilePath "setup.iss" -Encoding UTF8
          Write-Host "Inno Setup script created" -ForegroundColor Green
        shell: pwsh

      - name: Build installer with Inno Setup
        if: ${{ github.event.inputs.build_installer != 'false' }}
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" setup.iss
          Write-Host "Installer created successfully" -ForegroundColor Green
        shell: pwsh

      - name: Upload installer
        if: ${{ github.event.inputs.build_installer != 'false' }}
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: installer_output/*.exe
          if-no-files-found: warn

      # ============================================
      # RELEASE (apenas em tags)
      # ============================================
      - name: Get tag version
        if: startsWith(github.ref, 'refs/tags/v')
        id: tag
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
        shell: bash

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          name: "POS Moloni v${{ steps.tag.outputs.VERSION }}"
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            POS-Moloni-Windows-*.zip
            installer_output/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # JOB SEPARADO: MSIX (opcional)
  # ============================================
  build-msix:
    runs-on: windows-latest
    needs: build-windows
    if: ${{ github.event.inputs.build_installer != 'false' && startsWith(github.ref, 'refs/tags/v') }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: true

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Clean and get dependencies
        run: |
          flutter clean
          flutter pub get

      - name: Generate code
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Create MSIX config
        run: |
          @"
          msix_config:
            display_name: POS Moloni
            publisher_display_name: Loja da Madalena
            identity_name: com.lojadamadalena.posmoloni
            publisher: CN=Loja da Madalena, O=Loja da Madalena, C=PT
            msix_version: 1.0.0.0
            logo_path: assets/icons/app_icon.png
            capabilities: internetClient
            languages: pt-PT, en-US
          "@ | Out-File -FilePath "pubspec_msix.yaml" -Encoding UTF8
        shell: pwsh

      - name: Add msix dependency
        run: flutter pub add msix --dev

      - name: Build MSIX
        run: flutter pub run msix:create
        continue-on-error: true

      - name: Upload MSIX
        uses: actions/upload-artifact@v4
        with:
          name: windows-msix
          path: build/windows/x64/runner/Release/*.msix
          if-no-files-found: warn